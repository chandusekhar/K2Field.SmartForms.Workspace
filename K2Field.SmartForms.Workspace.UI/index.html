<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=10">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>K2 Workbench</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="css/plugins/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Timeline CSS -->
    <link href="css/plugins/timeline.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="css/plugins/morris.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome-4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!--<i data-bind="attr:{class: workspace().Icon()}" class="navbar-brand"></i>--><a class="navbar-brand" href="index.html" data-bind="text: workspace().DisplayName()"></a>
            </div>
            <!-- /.navbar-header -->

            <ul class="nav navbar-top-links navbar-right">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-tablet fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-messages" data-bind="foreach: workspaceUser().Workspaces()">
                        <li>
                            <a class="workspaceselect" data-bind="attr: {id: Id()}, click: $root.changeWorkspace" href="#">
                                <div>
                                    <i data-bind="attr:{class: Icon}"></i>&nbsp;&nbsp;<strong data-bind="text: DisplayName()"></strong>
                                </div>
                                <div data-bind="text: Description()"></div>
                            </a>
                        </li>
                        <!--<li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <strong>John Smith</strong>
                                    <span class="pull-right text-muted">
                                        <em>Yesterday</em>
                                    </span>
                                </div>
                                <div>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eleifend...</div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <strong>John Smith</strong>
                                    <span class="pull-right text-muted">
                                        <em>Yesterday</em>
                                    </span>
                                </div>
                                <div>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eleifend...</div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a class="text-center" href="#">
                                <strong>Read All Messages</strong>
                                <i class="fa fa-angle-right"></i>
                            </a>
                        </li>-->
                    </ul>
                    <!-- /.dropdown-messages -->
                </li>

                <!-- /.dropdown -->
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li><a href="#"><i class="fa fa-gear fa-fw"></i> Settings</a>
                        </li>
                        <li class="divider"></li>
                        <li><a href="login.html"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul>
                    <!-- /.dropdown-user -->
                </li>
                <!-- /.dropdown -->
            </ul>
            <!-- /.navbar-top-links -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <!--<li class="sidebar-search">
                            <div class="input-group custom-search-form">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                            </div>
                        </li>-->


                            <!--ko foreach: workspace().Links() -->

                            <!--ko if: IsHeading() == false -->
                            <li>
                                <a class="linkurl" data-bind="attr:{href: Url, id: Id}"><i data-bind="attr:{class:Icon}"></i>&nbsp;<span data-bind="text: DisplayName"></span></a>
                            </li>

                            <!--/ko-->
                            <!--ko if: IsHeading() == true -->
                            <li>
                                <a data-bind="attr:{href: Url, id: Id}" class="linkurl"><i data-bind="attr:{class:Icon}"></i>&nbsp;<span data-bind="text: DisplayName"></span><span class="fa arrow"></span></a>
                                <ul class="nav nav-second-level" data-bind="foreach: ChildLinks">
                                    <li>
                                        <a class="linkurl" data-bind="attr:{href: Url, id: Id}">
                                            <i data-bind="attr:{class:Icon}"></i>&nbsp;
                                            <span data-bind="text: DisplayName"></span>
                                        </a>
                                    </li>
                                </ul>
                            </li>

                            <!--/ko-->

                            <!--/ko-->

                        </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    &nbsp;
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12"><ul id="msgReceived"></ul>
                    <iframe id="contentFrame" frameborder="0" src="https://k2.denallix.com/designer/"></iframe>
                </div>
            </div>

            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery Version 1.11.0 -->
    <script src="js/jquery-1.11.0.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="js/plugins/metisMenu/metisMenu.js"></script>

    <!-- Morris Charts JavaScript -->
    <script src="js/plugins/morris/raphael.min.js"></script>
    <script src="js/plugins/morris/morris.min.js"></script>
    <script src="js/plugins/morris/morris-data.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/sb-admin-2.js"></script>

    <script src="js/knockout-3.2.0.js"></script>
    <script src="js/knockout.mapping-latest.js"></script>

    <script src="js/plugins/linqjs/linq.js"></script>
    <script src="js/plugins/linqjs/jquery.linq.js"></script>

    <script type="text/javascript">

    function koworkspace(data) {

        if (data && data.Id) {
            this.Id = ko.observable(data.Id);
        } else {
            this.Id = ko.observable();
        }

        if (data && data.Name) {
            this.Name = ko.observable(data.Name);
        } else {
            this.Name = ko.observable();
        }

        if (data && data.DisplayName) {
            this.DisplayName = ko.observable(data.DisplayName);
        } else {
            this.DisplayName = ko.observable();
        }

        if (data && data.Description) {
            this.Description = ko.observable(data.Description);
        } else {
            this.Description = ko.observable();
        }

        if (data && data.SmartFormsRuntimeUrl) {
            this.SmartFormsRuntimeUrl = ko.observable(data.SmartFormsRuntimeUrl);
        } else {
            this.SmartFormsRuntimeUrl = ko.observable();
        }

        if (data && data.Icon) {
            this.Icon = ko.observable(data.Icon);
        } else {
            this.Icon = ko.observable();
        }

        if (data && data.StartUrl) {
            this.StartUrl = ko.observable(data.StartUrl);
        } else {
            this.StartUrl = ko.observable();
        }


        if (data && data.Links) {
            this.Links = ko.observableArray([]);

            // order links on sequence
            var orderedLinks = Enumerable.From(data.Links).OrderBy(function (item) { return item.Sequence }).ToArray();

            //for (var i = 0; i < data.Links.length; i++) {
            //    this.Links.push(new kolink(data.Links[i]));
            //}

            for (var i = 0; i < orderedLinks.length; i++) {
                this.Links.push(new kolink(orderedLinks[i]));
            }

        } else {
            this.Links = ko.observableArray([]);
        }
    }

    function kolink(data) {

        if (data && data.Id) {
            this.Id = ko.observable(data.Id);
        } else {
            this.Id = ko.observable();
        }

        if (data && data.Name) {
            this.Name = ko.observable(data.Name);
        } else {
            this.Name = ko.observable();
        }

        if (data && data.DisplayName) {
            this.DisplayName = ko.observable(data.DisplayName);
        } else {
            this.DisplayName = ko.observable();
        }
        if (data && data.Description) {
            this.Description = ko.observable(data.Description);
        } else {
            this.Description = ko.observable();
        }
        if (data && data.SmartForm) {
            this.SmartForm = ko.observable(data.SmartForm);
        } else {
            this.SmartForm = ko.observable();
        }

        if (data && data.Url) {
            this.Url = ko.observable(data.Url);
        } else {
            this.Url = ko.observable("");
        }

        if (data && data.IsSmartForm) {
            this.IsSmartForm = ko.observable(data.IsSmartForm);
        } else {
            this.IsSmartForm = ko.observable();
        }

        if (data && data.Level) {
            this.Level = ko.observable(data.Level);
        } else {
            this.Level = ko.observable();
        }

        if (data && data.Type) {
            this.Type = ko.observable(data.Type);
        } else {
            this.Type = ko.observable();
        }

        if (data && data.Icon) {
            this.Icon = ko.observable(data.Icon);
        } else {
            this.Icon = ko.observable();
        }

        if (data && data.IsEnabled) {
            this.IsEnabled = ko.observable(data.IsEnabled);
        } else {
            this.IsEnabled = ko.observable();
        }

        if (data && data.Sequence) {
            this.Sequence = ko.observable(data.Sequence);
        } else {
            this.Sequence = ko.observable();
        }

        if (data && data.MinHeight) {
            this.MinHeight = ko.observable(data.MinHeight);
        } else {
            this.MinHeight = ko.observable();
        }

        if (data && data.ChildLinks) {
            this.ChildLinks = ko.observableArray([]);

            // order links on sequence
            var orderedLinks = Enumerable.From(data.ChildLinks).OrderBy(function (item) { return item.Sequence }).ToArray();

            //for (var i = 0; i < data.ChildLinks.length; i++) {
            //    this.ChildLinks.push(new kolink(data.ChildLinks[i]));
            //}

            for (var i = 0; i < orderedLinks.length; i++) {
                this.ChildLinks.push(new kolink(orderedLinks[i]));
            }

            //this.IsHeading = ko.computed(function () {
            //    return true;
            //}, data);

            if (data.ChildLinks.length > 0) {
                this.IsHeading = ko.observable(true);
            } else {
                this.IsHeading = ko.observable(false);
            }

        } else {
            this.ChildLinks = ko.observableArray([]);

            //this.IsHeading = ko.computed(function () {
            //    return false;
            //}, data);

            this.IsHeading = ko.observable(false);
        }

    }

    function koidentity(data) {

        if (data && data.IdentityName) {
            this.IdentityName = ko.observable(data.IdentityName);
        } else {
            this.IdentityName = ko.observable();
        }

        if (data && data.IsAuthenticated) {
            this.IsAuthenticated = ko.observable(data.IsAuthenticated);
        } else {
            this.IsAuthenticated = ko.observable();
        }

        if (data && data.AuthenticationType) {
            this.AuthenticationType = ko.observable(data.AuthenticationType);
        } else {
            this.AuthenticationType = ko.observable();
        }

        if (data && data.Claims) {
            this.Claims = ko.observableArray([]);

            for (var i = 0; i < data.Claims.length; i++) {
                this.Claims.push(new koclaim(data.Claims[i]));
            }
        }
    }

    function koclaim(data) {

        if (data && data.Type) {
            this.Type = ko.observable(data.Type);
        } else {
            this.Type = ko.observable();
        }

        if (data && data.Value) {
            this.Value = ko.observable(data.Value);
        } else {
            this.Value = ko.observable();
        }
    }

    function koworkspaceuser(data) {

        if (data && data.Username) {
            this.Username = ko.observable(data.Username);
        } else {
            this.Username = ko.observable();
        }

        if (data && data.DisplayName) {
            this.DisplayName = ko.observable(data.DisplayName);
        } else {
            this.DisplayName = ko.observable();
        }
        if (data && data.FQN) {
            this.FQN = ko.observable(data.FQN);
        } else {
            this.FQN = ko.observable();
        }
        if (data && data.Email) {
            this.Email = ko.observable(data.Email);
        } else {
            this.Email = ko.observable();
        }
        if (data && data.IsActive) {
            this.IsActive = ko.observable(data.IsActive);
        } else {
            this.IsActive = ko.observable();
        }
        if (data && data.Workspaces) {
            this.Workspaces = ko.observableArray([]);

            for (var i = 0; i < data.Workspaces.length; i++) {
                this.Workspaces.push(new koworkspace(data.Workspaces[i]));
            }
        }
    }


    var baseUrl = "http://localhost:1476";
    //var baseUrl = "https://localhost:44302";

    var workspaceViewModel = {

        identity: ko.observable(),
        rawIdentity: [],


        workspaceUser: ko.observable(),
        rawWorkspaceUser: [],

        rawWorkspace: [],
        workspace: ko.observable(),

        activeWorkspace: ko.observable(),

        getIdentity: function () {
            $.ajax({
                url: baseUrl + '/api/identity/',
                method: 'GET',
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    workspaceViewModel.rawIdentity = data;

                    workspaceViewModel.identity(new koidentity(data));

                    $.event.trigger("identityGetSuccess");

                },
                error: function (request, textStatus, errorThrown) {
                    $.event.trigger('identityGetError');

                    alert("Error: " + textStatus + " :: " + errorThrown);
                },
                complete: function (request, textStatus) {
                    $.event.trigger('identityGetComplete');

                }
            });
        },

        getProfile: function () {
            $.ajax({
                url: baseUrl + '/api/workspaceUser/?username='+workspaceViewModel.identity().IdentityName(),
                method: 'GET',
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    workspaceViewModel.rawWorkspaceUser = data;

                    workspaceViewModel.workspaceUser(new koworkspaceuser(data));

                    // set default/active workspace
                    workspaceViewModel.activeWorkspace(workspaceViewModel.workspaceUser().Workspaces()[0]);
                    workspaceViewModel.workspace(workspaceViewModel.activeWorkspace());

                    $.event.trigger("getProfileGetSuccess");

                },
                error: function (request, textStatus, errorThrown) {
                    $.event.trigger('getProfileGetError');

                    alert("Error: " + textStatus + " :: " + errorThrown);
                },
                complete: function (request, textStatus) {
                    $.event.trigger('getProfileGetComplete');

                }
            });
        },

        load: function (id) {
            $.ajax({
                url: baseUrl+'/api/workspace/' + id,
                method: 'GET',
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    workspaceViewModel.rawWorkspace = data;
                    //locationViewModel.location(ko.mapping.fromJS(data));
                    workspaceViewModel.workspace(new koworkspace(data));

                    $.event.trigger("workspaceLoadSuccess");

                },
                error: function (request, textStatus, errorThrown) {
                    $.event.trigger('workspaceLoadError');

                    alert("Error: " + textStatus + " :: " + errorThrown);
                },
                complete: function (request, textStatus) {
                    $.event.trigger('workspaceLoadComplete');

                }
            });
        },

        changeWorkspace: function(item) {
            workspaceViewModel.activeWorkspace(item);
            workspaceViewModel.workspace(item);
            // for side menu
            //$('#side-menu').metisMenu();
            $.event.trigger("getProfileGetSuccessBeta");

        },

        loadWorkspaceLocal: function(id) {

            var ws = false;

            for(var i=0;i<workspaceViewModel.workspace().Workspaces().length;i++) {
                if (workspaceViewModel.workspace().Workspaces()[i].Id() == id) {
                    ws = workspaceViewModel.workspace().Workspaces()[i];
                }
            }
            
            if (ws != false) {
                workspaceViewModel.activeWorkspace = ws;
            }

            return ws;
        },

        loadLinkLocal: function (id) {
            var link;
            link = workspaceViewModel.findLink(workspaceViewModel.workspace().Links(), id);
            if (link != false) {
                workspaceViewModel.selectedLink = link;
            }

            return link;
        },

        findLink: function (links, id) {
            for (var i = 0; i < links.length; i++) {
                if (links[i].Id() == id) {
                    return links[i];
                } else if (links[i].ChildLinks().length > 0) {
                    var l = workspaceViewModel.findLink(links[i].ChildLinks(), id);
                    if (l != false) {
                        return l;
                    }
                }
            }
            return false;
        },
    };

    //workspaceViewModel.load('9c6537b4-6823-e411-8374-000c297c26af');
    var ii = 0;


    $(document).on("getProfileGetSuccess", function () {
        ko.applyBindings(workspaceViewModel);

        initUI()
    });

    $(document).on("getProfileGetSuccessBeta", function () {
        //ko.applyBindings(workspaceViewModel);

        initUI();
        resetMenu();
    });

    function isIE() {
        var undef,
                v = 3,
                div = document.createElement("div"),
                all = div.getElementsByTagName("i");

        while (
            div.innerHTML = "<!--[if gt IE " + (++v) + "]><i></i><![endif]-->",
            all[0]
        ) {
            return v > 4 ? v : undef;
        }
    }

    var togg = false;

    function resetMenu() {
        var $this = $("#side-menu"),
                $toggle = togg;

        if (this.isIE() <= 9) {
            $this.find("li.active").has("ul").children("ul").collapse("show");
            $this.find("li").not(".active").has("ul").children("ul").collapse("hide");
        } else {
            $this.find("li.active").has("ul").children("ul").addClass("collapse in");
            $this.find("li").not(".active").has("ul").children("ul").addClass("collapse");
        }

        $this.find("li").has("ul").children("a").on("click", function (e) {
            e.preventDefault();

            $(this).parent("li").toggleClass("active").children("ul").collapse("toggle");

            if ($toggle) {
                $(this).parent("li").siblings().removeClass("active").children("ul.in").collapse("hide");
            }
        });
    }

    function initUI() {

        // for side menu
        $('#side-menu').metisMenu({
            toggle: togg
        });

        // loads iframe on menu click
        $('a.linkurl').on('click', function (e) {
            e.preventDefault();
            var url = $(this).attr('href');
            if (url != '' && (url != window.location.href && url != '#')) {
                $('#contentFrame').attr('src', url);
            }

            // get id
            var selectedLink = workspaceViewModel.loadLinkLocal(e.target.id);

            if (selectedLink != false) {
                if (selectedLink.MinHeight() > 0) {
                    $('#contentFrame').css('min-height', selectedLink.MinHeight() + 'px');
                } else {
                    $('#contentFrame').css('min-height', '100%');
                }
            }

        });

        $('#contentFrame').load(function () {

            //$('#contentFrame').css('min-height', '100%');
            $('#contentFrame').css('min-width', '100%');

            //$(this).height($(this).contents().height());
            //$(this).width($(this).contents().width());            

        });

    }

    $(document).on("identityGetSuccess", function () {
        workspaceViewModel.getProfile();
    });



    //$(document).ready(function () {
    //    regMessageReceive();
    //});


    function regMessageReceive() {
        // for older Internet Explorer
        if (window.attachEvent) {
            attachEvent("onmessage", receiveMessage);
        } else {

            window.addEventListener("message", receiveMessage, false);
        }
    }

    function receiveMessage(e) {

        // assuming message is in correct format
        var msg = JSON.parse(e.data);
        if (msg.fromUrl != window.location.href) {            
            //$('#msgReceived').prepend('<li>' + msg.message + '</li>');

            if (msg.messageType == "AppPartResizeToPage" || msg.messageType == "AppPartResize") {
                // resize contentFrame to height

                $('#contentFrame').css('min-height', msg.messageId);
            }
        }
    }


    // cos ready not working for some reason
    regMessageReceive();


    workspaceViewModel.getIdentity();

    </script>





</body>

</html>
